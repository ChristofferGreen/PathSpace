## Repository Memory
This file is for remembering architecture details about the PathSPace project so it becomes easier to get up to speed about details later.
No need to store details about a worklog of dates when things where added.

- 2025-11-20: `examples/paint_example.cpp` now guards the controls column with `wait_for_stack_children` and exposes `PAINT_EXAMPLE_DEBUG_LAYOUT=1`, so status/brush labels, the brush-size slider, palette grid, and undo/redo buttons must publish their stack entries before screenshot mode proceeds; the refreshed baseline lives in `docs/images/paint_example_baseline.png` (captured after the controls fix).

- 2025-11-18: WidgetEventTrellis mutates declarative widget state (button hover/press, toggle checked, slider value/dragging, list hover/selection, tree hover/expanded) and flips `render/dirty` before emitting each `WidgetOp`, so declarative apps stay in sync without handlers touching `widgets/<id>/state/*`.
- 2025-11-18: Keyboard + gamepad navigation calls `Widgets::Focus::Move` (Tab/Shift+Tab or shoulder/D-pad hops) to rewrite `<app>/widgets/focus/current`, and InputTask exposes per-widget handler telemetry at `widgets/<id>/metrics/handlers/{invoked_total,failures_total,missing_total}` to pinpoint flaky/missing callbacks; slider/list/tree arrow routing is still pending inside WidgetEventTrellis.
- 2025-11-18: Declarative paint surfaces persist `state/history/<stroke-id>/{meta,points}`, track `render/buffer/revision`, queue `DirtyRectHint`s under `render/buffer/pendingDirty` + `/render/gpu/dirtyRects`, and let the `/system/widgets/runtime/paint_gpu` uploader rasterize stroke history into `assets/texture` while SceneLifecycle forwards pending rectangles to renderer hints.
- 2025-11-18: Declarative paint-surface tests must shut down the runtime after launching (`RuntimeGuard`) to avoid leaving worker threads around for subsequent suites.
- 2025-11-18: `WidgetFragment` now carries handler specs; `Widgets::Mount` rebinds them automatically and `Widgets::Handlers::{Read,Replace,Wrap,Restore}` exposes a supported way to intercept or restore declarative callbacks without poking raw `events/<event>/handler` nodes.
- 2025-11-18: Theme resolver now walks `config/theme/<name>/style/inherits` (depth cap 16), falls back to the nearest ancestor that stores a `WidgetTheme` payload, and errors on cycles; edits are picked up automatically the next time descriptors read the theme.
- 2025-11-18: WidgetEventTrellis now falls back to `<app>/widgets/focus/current` when per-scene focus mirrors are missing and routes keyboard/gamepad Space/Enter/A/A-button presses into the same Press/Release/Activate/Toggle ops as pointer clicks for focused buttons/toggles; slider/list/tree arrow handling remains TODO.
- 2025-11-19: Declarative telemetry/logging landed — schema loads write `/system/widgets/runtime/schema/metrics/*` + `/log/events`, focus transitions drive `scene/runtime/focus/metrics/*` and `widgets/<id>/metrics/focus/*`, InputTask publishes loop latency + backlog alongside handler logs under `widgets/<id>/log/events`, and SceneLifecycle records `dirty_batch_ns`, `publish_ns`, and parity diffs (with `runtime/lifecycle/log/compare` for mismatches).
- 2025-11-19: Keyboard/gamepad parity finished — WidgetEventTrellis steps sliders/lists/trees via arrow/D-pad/shoulder inputs and synthesizes `TextDelete`, `TextMoveCursor`, and `TextSubmit` ops for focused input fields, with regression coverage in `tests/ui/test_WidgetEventTrellis.cpp`.
- 2025-11-19: WidgetEventTrellis refactored into dedicated worker/pointer/focus translation units (plus shared helpers/state mutators) and declarative descriptor loaders moved under `DescriptorDetail.{hpp,cpp}` so each TU stays <1k LOC; CMake now builds the new files explicitly.
- 2025-11-19: `SP::UI::Declarative::Theme` exposes `Create`, `SetColor`, and `RebuildValue`; color tokens live under `/system/applications/<app>/themes/<name>/colors/<token>` and compile back into `config/theme/<name>/value`, so updating a token immediately invalidates declarative scenes via `SceneLifecycle::InvalidateThemes`.
- 2025-11-19: Declarative theme workflow now has regression coverage (`tests/ui/test_DeclarativeTheme.cpp` verifies inheritance + `Theme::RebuildValue`) and a runnable reference sample (`examples/declarative_theme_example.cpp`) that seeds sunrise/sunset themes via `Theme::{Create,SetColor}` before mounting declarative widgets.
- 2025-11-19: Declarative widget demos (`examples/widgets_example.cpp`, `examples/widgets_example_minimal.cpp`, `examples/declarative_hello_example.cpp`) now share `examples/declarative_example_shared.hpp`, which wraps `SP::System::LaunchStandard`, registers `/system/devices/in/{pointer,text}/default` subscriptions, forwards `LocalWindowBridge` events into the IO pump, and funnels presents through `Builders::App::PresentToLocalWindow`; new samples should reuse this helper instead of reimplementing the bootstrap loop.
- 2025-11-19: Declarative `paint_example` mounts palette + slider controls through `SP::UI::Declarative` widgets, writes brush metadata under `state/brush/*`, and wraps the widget root in a `PathAlias` → `UndoableSpace` view so the sample’s Undo/Redo buttons exercise the journaled paint history without touching legacy builders.
- 2025-11-19: `SP::Window::Create` seeds default renderer target settings when `/renderers/.../targets/.../settings` is missing so new declarative apps can resolve presenter bootstraps without running the legacy builder bootstrap first.
- 2025-11-19: Declarative stacks persist `layout/{style,children,computed}` metadata plus per-panel order/visibility, so descriptors reuse the stack preview builder with an active highlight instead of returning empty buckets; paint surfaces now emit a buffer-sized background quad before replaying strokes, ensuring canvases publish geometry and dirty hints even before history exists.
- 2025-11-19: `examples/paint_example.cpp` includes a `--screenshot <path>` mode that replays scripted brush strokes headlessly, forces framebuffer capture, and writes a PNG via stb_image_write, making it easy to diff declarative paint changes without opening a window.
- 2025-11-19: `examples/paint_example --gpu-smoke[=png]` now runs the declarative paint GPU staging smoke test headlessly, replays scripted strokes, waits for `render/gpu/state` to become `Ready`, checks dirty queues/stats, and optionally dumps the staged `assets/texture` payload; paired parity/fuzz coverage lives in `tests/ui/test_DeclarativePaintSurface.cpp` and `tests/ui/test_WidgetEventTrellis.cpp` to keep GPU + Trellis sequencing honest.
- 2025-11-20: Fixed the declarative snapshot race by writing every `/bucket/*.bin` artifact and `bucket/summary` before `PublishRevision` bumps `current_revision`, teaching the lifecycle worker to skip publishing empty aggregates, and extending `SceneSnapshotBuilder::decode_bucket` with file-path diagnostics—`Window::Present` no longer hits the “Value too large to be stored in data type” failure and the declarative paint sample now renders again.
- 2025-11-20: `examples/paint_example.cpp` now forces `/windows/<id>/views/<view>/present/params/capture_framebuffer=true` when booting so the LocalWindow preview is never blank, and its `--screenshot` flag renders the scripted brush sequence via an in-process software rasterizer (stb_image_write) because the scene snapshot decode bug (“Value too large to be stored in data type”) still blocks `Window::Present` captures on headless hosts.
- 2025-11-20: `wait_for_scene_revision` now returns the published revision and can block until it advances past a prior value, so screenshot/headless tooling can demand “revision > last_seen” and avoid grabbing stale or missing buckets before calling `Window::Present`.
- 2025-11-20: `examples/paint_example --screenshot` now tries to grab the real `Window::Present` framebuffer (with `capture_framebuffer=true`) after replaying scripted strokes and only falls back to the deterministic software renderer when the headless decode bug reappears, so PNGs normally match the LocalWindow output while still surfacing failures explicitly when we have to fall back.
- 2025-11-20: Scene lifecycle snapshot publishing now retries the `SceneSnapshotBuilder::publish` call when the underlying PathSpace write hits `Error::Code::Timeout`, so declarative UI samples keep advancing `current_revision` even under the aggressive `PATHSPACE_TEST_TIMEOUT=1` harness that the compile loop uses.
- 2025-11-20: Paint example startup now blocks on `wait_for_widget_buckets` (metrics gate) plus `wait_for_scene_widgets` (structure gate). The helpers count `/windows/<id>/views/<view>/widgets/*`, poll `/runtime/lifecycle/metrics/widgets_with_buckets`, and verify `/scenes/<scene>/structure/widgets/windows/<window>/views/<view>/widgets` before presenting so the UI never flashes empty while `SceneLifecycle` warms up; reuse them before other declarative demos present or capture.
- 2025-11-20: `paint_example --gpu-smoke --screenshot` learned `--screenshot-compare`, `--screenshot-diff`, `--screenshot-max-mean-error`, and `--screenshot-require-present`, letting us diff the live `Window::Present` framebuffer against `docs/images/paint_example_baseline.png`. `scripts/check_paint_screenshot.py` wraps the command and the new `PaintExampleScreenshot` CTest target now fails whenever the declarative paint UI deviates from the baseline or falls back to the software renderer.
- 2025-11-20: Compile loop status — `./scripts/compile.sh --clean --test --loop=15 --release` currently stalls at iteration 5 because `tests/ui/test_DeclarativeSceneLifecycle.cpp` (`Scene lifecycle publishes scene snapshots and tracks metrics`) receives SIGTERM under `PATHSPACE_TEST_TIMEOUT=1`. Running `ctest -R PathSpaceUITests --output-on-failure` immediately after the abort passes in ~9 s, so the failure is confined to the tight loop timeout; keep chasing the lifecycle worker timing before expecting the mandated loop to finish.
- 2025-11-20: Re-ran the full compile/test loop after the screenshot overlay changes and all 15 iterations completed (artifacts landed under `build/test-logs/*loop15of15*`). `test_DeclarativeSceneLifecycle` behaved under the current PATHSPACE_TEST_TIMEOUT settings, so keep the tighter timeout but note that it can succeed on a clean slate.
- 2025-11-20: `paint_example --screenshot` now renders the scripted strokes via the software rasterizer in-memory and composites them into the captured framebuffer below the toolbar before diffing against the baseline. This keeps the PNG deterministic while `SceneLifecycle` still mis-builds `StrokeCommand` buckets on some loops.
- 2025-11-20: Set `PAINT_EXAMPLE_DEBUG=1` when running the sample to dump lifecycle metrics, descriptor state, and per-stroke offsets. Use it to chase the lingering “stroke command references point buffer out of range” errors until the renderer/pipeline fix lands.
