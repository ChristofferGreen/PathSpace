name: CI

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: core-only
            extra: "OFF"
            app: "OFF"
            ui: "OFF"
            software: "OFF"
            metal: "OFF"
          - name: core-plus-app
            extra: "ON"
            app: "ON"
            ui: "OFF"
            software: "OFF"
            metal: "OFF"
          - name: full-software-ui
            extra: "ON"
            app: "ON"
            ui: "ON"
            software: "ON"
            metal: "OFF"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Configure (${{ matrix.config.name }})
        run: |
          cmake -S . -B build-${{ matrix.config.name }} -G Ninja \
            -DPATHSPACE_ENABLE_EXTRA=${{ matrix.config.extra }} \
            -DPATHSPACE_ENABLE_APP=${{ matrix.config.app }} \
            -DPATHSPACE_ENABLE_UI=${{ matrix.config.ui }} \
            -DPATHSPACE_UI_SOFTWARE=${{ matrix.config.software }} \
            -DPATHSPACE_UI_METAL=${{ matrix.config.metal }} \
            -DBUILD_PATHSPACE_EXAMPLES=OFF

      - name: Build (${{ matrix.config.name }})
        run: cmake --build build-${{ matrix.config.name }}

      - name: Test (${{ matrix.config.name }})
        env:
          PATHSPACE_LEGACY_WIDGET_BUILDERS: error
          PATHSPACE_LEGACY_WIDGET_BUILDERS_REPORT: ${{ github.workspace }}/build-${{ matrix.config.name }}/legacy_builders_ci.jsonl
        run: ctest --test-dir build-${{ matrix.config.name }} --output-on-failure

  metal-macos:
    runs-on: macos-latest
    env:
      PKG_CONFIG_PATH: "/opt/homebrew/opt/icu4c/lib/pkgconfig:/opt/homebrew/lib/pkgconfig:/opt/homebrew/share/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/share/pkgconfig:${PKG_CONFIG_PATH}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja pkg-config harfbuzz icu4c || true

      - name: Build & Test (metal presenter)
        env:
          PATHSPACE_LEGACY_WIDGET_BUILDERS: error
          PATHSPACE_LEGACY_WIDGET_BUILDERS_REPORT: ${{ github.workspace }}/build/legacy_builders_ci_macos.jsonl
        run: ./scripts/compile.sh --release --test --loop=1 --per-test-timeout 20 --enable-metal-tests

  loop-stability:
    needs: build
    runs-on: macos-latest
    env:
      PKG_CONFIG_PATH: "/opt/homebrew/opt/icu4c/lib/pkgconfig:/opt/homebrew/lib/pkgconfig:/opt/homebrew/share/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/share/pkgconfig:${PKG_CONFIG_PATH}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja pkg-config harfbuzz icu4c || true

      - name: Run loop-stability harness
        env:
          PATHSPACE_TEST_TIMEOUT: "1"
          PATHSPACE_LOOP_KEEP_LOGS: PathSpaceUITests
          PATHSPACE_RECORD_MANUAL_PUMPS: "1"
          PATHSPACE_LOOP_BASELINE_OUT: ${{ github.workspace }}/loop_baseline.json
          PATHSPACE_LEGACY_WIDGET_BUILDERS: error
          PATHSPACE_LEGACY_WIDGET_BUILDERS_REPORT: ${{ github.workspace }}/build/legacy_builders_loop.jsonl
        run: ./scripts/compile.sh --clean --test --loop=5 --release --per-test-timeout 20

      - name: Kill-switch dry run
        env:
          PATHSPACE_LEGACY_WIDGET_BUILDERS: error
          PATHSPACE_LEGACY_WIDGET_BUILDERS_REPORT: ${{ github.workspace }}/build-kill-switch-loop/legacy_builders_kill_switch.jsonl
        run: ./scripts/kill_switch_dry_run.sh --build-dir build-kill-switch-loop

      - name: Upload loop-stability artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: loop-stability-logs
          path: |
            build/test-logs
            loop_baseline.json
            build-kill-switch-loop/test-logs
